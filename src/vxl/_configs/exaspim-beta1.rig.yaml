# uv run python examples/voxel/rig.py
# uv run vxl-node node_x 10.128.133.64
_anchors:
  # - &exaspim2-1_ip "10.128.133.64"
  - &exaspim2-2_ip "10.128.133.46"
  # - &exaspim2-3_ip "10.128.133.68"
  # - &exaspim2-4_ip "10.128.133.70"
  - &local_ip "127.0.0.1"
  - &camera_target vxl_drivers.cameras.simulated.SimulatedCamera
  - &sim_pixel_size_um "0.5,0.5"
  # - &sim_camera_sensor_px "10640,14192"
  # - &sim_camera_sensor_px "7980,10,644"
  - &sim_camera_sensor_px "5320,7096"
  # - &sim_camera_sensor_px "2660,3548"
  # - &sim_camera_sensor_px "1330,1774"
  - &laser_target vxl_drivers.lasers.simulated.SimulatedLaser
  - &aotf_laser_target vxl_drivers.lasers.simulated.SimulatedAOTFShutteredLaser
  - &aotf_target vxl_drivers.aotf.simulated.SimulatedAotf
  - &daq_target vxl_drivers.daqs.simulated.SimulatedDaq
  - &fw_target vxl_drivers.axes.simulated.SimulatedDiscreteAxis
  - &linear_axis_target vxl_drivers.axes.simulated.SimulatedContinuousAxis
  - &default_timing
    sample_rate: "100 kHz"
    duration: "0.2 s"
    rest_time: "0.05 s"
  - &camera_waveform_ch1
    type: pulse
    voltage: { min: 0.0, max: 5.0 }
    window: { min: 0.0, max: 0.95 }
  - &camera_waveform_ch2
    type: pulse
    voltage: { min: 0.0, max: 5.0 }
    window: { min: 0.02, max: 0.97 } # 2% delay (2ms at 100ms duration)
  - &laser_waveform_ch1
    type: pulse
    voltage: { min: 0.0, max: 5.0 }
    window: { min: 0.1, max: 0.9 }
  - &laser_waveform_ch2
    type: pulse
    voltage: { min: 0.0, max: 5.0 }
    window: { min: 0.12, max: 0.92 } # 2% delay
  - &aotf_blanking_waveform
    type: pulse
    voltage: { min: 0.0, max: 5.0 }
    window: { min: 0.05, max: 0.95 } # Wide blanking window

info:
  name: "LightSheetMicroscope_01"

cluster:
  control_port: 9000

nodes:
  primary:
    devices:
      daq_1:
        target: *daq_target
        init: { device_name: "MockDev1" }
      aotf_1:
        target: *aotf_target
        init: { blanking_mode: "external" }
      x_axis:
        target: *linear_axis_target
        init: { lower_limit: 0.0, upper_limit: 40.0 }
      y_axis:
        target: *linear_axis_target
        init: { lower_limit: 0.0, upper_limit: 25.0 }
      z_axis:
        target: *linear_axis_target
        init: { lower_limit: 0.0, upper_limit: 50.0, has_ttl_stepper: true }
      laser_405:
        target: *aotf_laser_target
        init:
          wavelength: 405
          aotf: aotf_1
          aotf_channel: 1
          aotf_frequency_mhz: 110.5
      laser_488:
        target: *aotf_laser_target
        init:
          wavelength: 488
          aotf: aotf_1
          aotf_channel: 2
          aotf_frequency_mhz: 98.2
      laser_561:
        target: *aotf_laser_target
        init:
          wavelength: 561
          aotf: aotf_1
          aotf_channel: 3
          aotf_frequency_mhz: 87.4
      laser_640:
        target: *aotf_laser_target
        init:
          wavelength: 640
          aotf: aotf_1
          aotf_channel: 4
          aotf_frequency_mhz: 78.6
      laser_730:
        target: *laser_target
        init: { wavelength: 730 }
      fw_detection_shared:
        target: *fw_target
        init:
          slots: { 0: "Quad-DGRC", 1: "Dual-DR", 2: "Dual-GC", 3: "NIR-LP720" }
      fw_emission_cam1:
        target: *fw_target
        init:
          slots: { 0: "BP450", 1: "BP525", 2: "BP600", 3: "BP780" }
      fw_emission_cam2:
        target: *fw_target
        init:
          slots: { 0: "BP525", 1: "BP700", 2: "BP780" }
      # fw_emission_cam3:
      #   target: *fw_target
      #   init:
      #     slots: { 0: "BP450", 1: "BP525", 2: "BP600", 3: "BP780" }
      # fw_emission_cam4:
      #   target: *fw_target
      #   init:
      #     slots: { 0: "BP525", 1: "BP700", 2: "BP780" }

  node_1:
    hostname: *local_ip
    devices:
      camera_1: &sim_camera
        target: *camera_target
        init:
          pixel_size_um: *sim_pixel_size_um
          sensor_size_px: *sim_camera_sensor_px
  node_2:
    hostname: *exaspim2-2_ip
    devices:
      camera_2: *sim_camera
  # node_3:
  #   hostname: *exaspim2-3_ip
  #   devices:
  #     camera_3: *sim_camera
  # node_4:
  #   hostname: *exaspim2-4_ip
  #   devices:
  #     camera_4: *sim_camera

stage:
  x: x_axis
  y: y_axis
  z: z_axis

daq:
  device: daq_1
  acq_ports:
    aotf_1: ao0
    camera_1: ao1
    camera_2: ao2
    # camera_3: ao3
    # camera_4: ao4
    laser_405: ao11
    laser_488: ao12
    laser_561: ao13
    laser_640: ao14
    laser_730: ao15

detection:
  camera_1:
    filter_wheels: [fw_detection_shared, fw_emission_cam1]
  camera_2:
    filter_wheels: [fw_detection_shared, fw_emission_cam2]
  # camera_3:
  #   filter_wheels: [fw_detection_shared, fw_emission_cam3]
  # camera_4:
  #   filter_wheels: [fw_detection_shared, fw_emission_cam4]

illumination:
  laser_405: {}
  laser_488: {}
  laser_561: {}
  laser_640: {}
  laser_730: {}

channels:
  dapi:
    detection: camera_1
    illumination: laser_405
    filters:
      fw_detection_shared: "Quad-DGRC"
      fw_emission_cam1: "BP450"
    desc: "DAPI nuclear stain using 405nm excitation"
    label: DAPI
    emission: 461
  gfp:
    detection: camera_2
    illumination: laser_488
    filters:
      fw_detection_shared: "Quad-DGRC"
      fw_emission_cam2: "BP525"
    desc: "Green fluorescent protein using 488nm excitation"
    label: GFP
    emission: 510
  rfp:
    detection: camera_1
    illumination: laser_561
    filters:
      fw_detection_shared: "Quad-DGRC"
      fw_emission_cam1: "BP600"
    desc: "Red fluorescent protein using 561nm excitation"
    label: RFP
    emission: 600
  cy5:
    detection: camera_2
    illumination: laser_640
    filters:
      fw_detection_shared: "Quad-DGRC"
      fw_emission_cam2: "BP700"
    desc: "Far-red Cy5 channel using 640nm excitation"
    label: Cy5
    emission: 670
  nir:
    detection: camera_1
    illumination: laser_730
    filters:
      fw_detection_shared: "NIR-LP720"
      fw_emission_cam1: "BP780"
    desc: "Near-infrared channel for iRFP/miRFP using 730nm excitation"
    label: NIR
    emission: 760

profiles:
  # Dual-channel profiles (simultaneous imaging on both cameras)
  dapi_gfp:
    channels: ["dapi", "gfp"]
    daq:
      timing: *default_timing
      waveforms:
        camera_1: *camera_waveform_ch1
        laser_405: *laser_waveform_ch1
        camera_2: *camera_waveform_ch2
        laser_488: *laser_waveform_ch2
        aotf_1: *aotf_blanking_waveform
    desc: "Simultaneous DAPI (cam1) and GFP (cam2) imaging"
  dapi_cy5:
    channels: ["dapi", "cy5"]
    daq:
      timing: *default_timing
      waveforms:
        camera_1: *camera_waveform_ch1
        laser_405: *laser_waveform_ch1
        camera_2: *camera_waveform_ch2
        laser_640: *laser_waveform_ch2
        aotf_1: *aotf_blanking_waveform
    desc: "Simultaneous DAPI (cam1) and Cy5 (cam2) imaging"
  gfp_rfp:
    channels: ["gfp", "rfp"]
    daq:
      timing: *default_timing
      waveforms:
        camera_1: *camera_waveform_ch1
        laser_561: *laser_waveform_ch1
        camera_2: *camera_waveform_ch2
        laser_488: *laser_waveform_ch2
        aotf_1: *aotf_blanking_waveform
    desc: "Simultaneous GFP (cam2) and RFP (cam1) imaging"
  rfp_cy5:
    channels: ["rfp", "cy5"]
    daq:
      timing: *default_timing
      waveforms:
        camera_1: *camera_waveform_ch1
        laser_561: *laser_waveform_ch1
        camera_2: *camera_waveform_ch2
        laser_640: *laser_waveform_ch2
        aotf_1: *aotf_blanking_waveform
    desc: "Simultaneous RFP (cam1) and Cy5 (cam2) imaging"
  # Single-channel profiles
  single_dapi:
    channels: ["dapi"]
    daq:
      timing: *default_timing
      waveforms:
        camera_1: *camera_waveform_ch1
        laser_405: *laser_waveform_ch1
        aotf_1: *aotf_blanking_waveform
    desc: "Single DAPI channel for nuclear staining"
  single_gfp:
    channels: ["gfp"]
    daq:
      timing: *default_timing
      waveforms:
        camera_2: *camera_waveform_ch1
        laser_488: *laser_waveform_ch1
        aotf_1: *aotf_blanking_waveform
    desc: "Single GFP channel imaging"
  single_rfp:
    channels: ["rfp"]
    daq:
      timing: *default_timing
      waveforms:
        camera_1: *camera_waveform_ch1
        laser_561: *laser_waveform_ch1
        aotf_1: *aotf_blanking_waveform
    desc: "Single RFP channel imaging"
  single_cy5:
    channels: ["cy5"]
    daq:
      timing: *default_timing
      waveforms:
        camera_2: *camera_waveform_ch1
        laser_640: *laser_waveform_ch1
        aotf_1: *aotf_blanking_waveform
    desc: "Single Cy5 far-red channel imaging"
  single_nir:
    channels: ["nir"]
    daq:
      timing: *default_timing
      waveforms:
        camera_1: *camera_waveform_ch1
        laser_730: *laser_waveform_ch1
    desc: "Single NIR channel for iRFP/miRFP imaging"
